<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="awesomplete.css" />
</head>
<body onload="init();">
Demo of the Recomovies project, select some movies or tv series that you like, to see recommendations: <br>
  <input id="myinput" />
  <div id="liked">
  </div>
  <input type="submit" id="sub" value="What should i watch?">
  <div id="reco"></div>
  <script src="awesomplete.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  function init(){
    var currentList = [];
    var lastId = [];
    var sugHistory = [];
    var inputHistory = [];
    var inHisIndex = 0;
    var noResults = [];
    var liked = document.getElementById('liked');
    var socket = io.connect('http://localhost:80');
    var input = document.getElementById("myinput");
    var awesomplete = new Awesomplete(input);
    var sub = document.getElementById('sub');
    var reco = document.getElementById('reco');
    sub.addEventListener('click', function(){
      if(lastId.length > 0){
        socket.emit('getReco', currentList);
      }
      console.log(currentList);
      currentList = [];
            console.log(currentList);

    });

    socket.on('reco', function(data){
      reco.innerHTML = "<h3>Recommended movies:</h3> <br>" + data;
      liked.innerHTML = "";
    });

    function changeList(newList){
      awesomplete.list = newList;
    }

    function nothingToShow(input){
      var nothing = false;
      for(var i = 0; i < noResults.length; i++){
        if(noResults[i] == input.substring(0, noResults[i].length))
        {
          nothing = true;
          break;
        }
      }
      return nothing;
    }

    document.addEventListener('selected', function (e) {
      currentList.push(lastId[e.detail]);
      var newLiked = document.createElement('p');
      var tempIndex = currentList.length;
      newLiked.innerHTML = input.value + "<a href='#' onclick='return false;'>(x)</a>";
      newLiked.querySelector('a').addEventListener('click', function(){
        liked.removeChild(newLiked);
        currentList.splice(tempIndex - 1, 1);
      });
      liked.appendChild(newLiked);
      input.value = "";
    }, false);


    input.addEventListener('input', function(){
      if(nothingToShow(this.value))
      {
        //show nothing
      }
      else if(typeof sugHistory[this.value] == 'undefined'){
      inputHistory.push(this.value);
      socket.emit('ask', this.value);
      }
      else{
        lastId = sugHistory[this.value].id;
        changeList(sugHistory[this.value].name);
      }
    });

    socket.on('suggest', function(data){
      var buffer = {'id': [], 'name': []}
      for(var i = 0; i < data.length; i++){
        buffer.name.push(data[i].l + ' (' + data[i].y + ')');
        buffer.id.push(data[i].id.split('tt')[1]);
      }
      lastId = buffer.id;
      changeList(buffer.name);
      sugHistory[inputHistory[inHisIndex]] = buffer;
      inHisIndex++;
    });

    socket.on('lastResults', function(input){
      noResults.push(input);
    });

  }
  </script>

</body>
</html>